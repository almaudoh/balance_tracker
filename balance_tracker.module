<?php

use Drupal\balance_tracker\Element\BalanceTable;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Url;
use Drupal\user\UserInterface;

/**
 * Implements of hook_user_view_alter().
 */
function balance_tracker_user_view_alter(array &$build, UserInterface $account, EntityViewDisplayInterface $display) {
  $current_user = \Drupal::currentUser();
  if ($build['#view_mode'] === 'full' && \Drupal::config('balance_tracker.settings')->get('show_in_profile')) {
    if ($current_user->hasPermission('view all balances') || ($current_user->hasPermission('view own balance') && $account->id() === $current_user->id())) {
      $balance = BalanceTable::formatCurrency(\Drupal::service('balance_tracker.storage')->getBalance($account->id()));
      $build['user_balance'] = [
        '#type' => 'item',
        '#markup' => '<h4 class="label">' . t('Current Balance') . '</h4> ' . $balance,
        'link' => [
          '#type' => 'link',
          '#title' => t('View full balance sheet'),
          '#url' => new Url('balance_tracker.user_balance', ['user' => $account->id()]),
          '#prefix' => '<p>',
          '#suffix' => '</p>',
        ],
      ];
    }
  }
}
